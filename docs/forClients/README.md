# Инструкция пользователя API (ru)

| Версия документа | Дата изменения | Причина            | Автор        |
| ---------------- | -------------- | ------------------ | ------------ |
| v1.0             | 2021-06-25     | Создание документа | Карпов Артем |

- [Инструкция пользователя API (ru)](#инструкция-пользователя-api-ru)
  - [Введение](#введение)
    - [Термины и определения](#термины-и-определения)
  - [Аутентификация](#аутентификация)
    - [Получение токена](#получение-токена)
      - [Запрос ендпоинта и идентификатора flow](#запрос-ендпоинта-и-идентификатора-flow)
      - [Запрос токена](#запрос-токена)
  - [Список основных методов](#список-основных-методов)

## Введение

Данный документ написан с целью предоставления клиенту описания API получения данных по посещаемости.  
Он предназначен для команд разработчиков, которым требуется настроить клиентский сервис(ы) импорта данных.

Архитектура API построена в соответствии с RESTful. В настоящий момент поддерживаемым форматом передачи данных является `application/json`.

Для работы с API необходимо иметь следующие параметры:

- url сервера аутентифкации (auth service)
- логин пользователя (адрес электронной почты)
- пароль
- url сервера API (api service)

### Термины и определения

**Лэйаут (layout)** - семантическая сеть (схема размещения) структуры объекта и снимаемых с него метрик. Корневой объект.

**Торговая сеть / Chain (chain)** - Категория лэйаута, физически это совокупность торговых объектов, которые находятся под общим управлением, или которые используются под единым коммерческим обозначением или иным средством индивидуализации.

**Торговый центр / Mall (mall)** - Категория лэйаута, физически это cовокупность торговых предприятий и/или предприятий по оказанию услуг, реализующих универсальный или специализированный ассортимент товаров и универсальный ассортимент услуг, расположенных на определенной территории в зданиях или строениях, спланированных, построенных и управляемых как единое целое и предоставляющих в границах своей территории стоянку для автомашин.

**Магазин / Store (store)** - Стационарный торговый объект, предназначенный для продажи товаров и оказания услуг покупателям, в составе которого имеется торговый зал или торговые залы, подсобные, административно-бытовые помещения и складские помещения. Как правило является частью какой-либо **Торговой сети**

**Вход, проход / Entrance (entrance)** - дверь, лестница, лифт, арка и т.п., на которых установлены счетчики посетителей, может иметь категории:

- *Вход / Entrance (entrance)* -  вход/выход в/из Торговый объект.
- *Мимоходящие / Passing-by (entrance.passing_by)* - Понятие используется для подсчета проходящих мимо какого-либо обычного прохода.
- *Переход / Transition (entrance.transition)* - Обычно используется для подсчета переходящих из одной зоны в другую посетителей.

**Зона / Zone (zone)** - Объединенная по какому-то логическому признаку область **магазина** или **Торгового центра**, определяется **проходами** с соответсвующими направлениями.

- может включать в себя одно или несколько помещений
- может не иметь совсем помещений (например: Переход из здания в здание, Зона лифтов, Холл)
- может включать в себя дочерние зоны (например: Зона 2-го этажа -> Зона арендаторов + Каток + Фудкорт)
- может быть периметровой, т.е. посещаемость этой зоны фактически = посещаемости Торгового центра

**Устройство / Device (device)** - Оборудование: контроллер системы подсчета посетителей, навигатор, коммутатор, wifi-роутер и пр.

**Счетчик / Sensor (sensor)** - Устройство, обычно связанное с контроллером, способное реагировать на определенное событие и формировать меру подсчета.

**Канал обслуживания / Service channel (service_channel)** - Каждая система массового обслуживания включает в свою структуру некоторое число обслуживающих устройств (единиц, приборов, линий), которые называют каналами обслуживания. Роль каналов могут играть лица, выполняющие те или иные операции (кассиры, операторы, продавцы, парикмахеры и т.д.), линии связи, автомашины, краны, ремонтные бригады, железнодорожные пути, бензоколонки и т.д.

**Место для персонала / Staff place (staff_place)** - Зона, определяющая место для персонала. Например: "Касса 1 / место кассира"

## Аутентификация

Для взаимодействия с API необходимо получить токен авторизации и во всех последующих запросах отправлять его в заголовках.

### Получение токена

Осуществляется в два этапа:

- запрос ендпоинта и идентификатора flow
- запрос токена

#### Запрос ендпоинта и идентификатора flow

| Параметр   | Значение                                        |
| ---------- | ----------------------------------------------- |
| HTTP метод | GET                                             |
| URL        | `https://<auth.service>/self-service/login/api` |
| Заголовок  | `Accept: application/json`                      |

CURL example:

```bash
curl -s -X GET -H "Accept: application/json" https://<auth.service>/self-service/login/api
```

response:

```json
{
  "id": "35873140-b35d-47c4-9317-57b40562d5fd",
  "type": "api",
  "expires_at": "2021-06-21T21:28:31.466543099Z",
  "issued_at": "2021-06-21T20:58:31.466543099Z",
  "request_url": "https://<auth.service>/self-service/login/api",
  "messages": null,
  "methods": {
    "password": {
      "method": "password",
      "config": {
        "action": "https://<auth.service>/self-service/login/methods/password?flow=35873140-b35d-47c4-9317-57b40562d5fd",
        "method": "POST",
        ...
```

Из ответа вам необходимо значение поля `methods.password.config.action`, например `https://<auth.service>/self-service/login/methods/password?flow=35873140-b35d-47c4-9317-57b40562d5fd`

#### Запрос токена

| Параметр     | Значение                                                                                               |
| ------------ | ------------------------------------------------------------------------------------------------------ |
| HTTP метод   | `POST`                                                                                                 |
| URL          | `https://<auth.service>/self-service/login/methods/password?flow=35873140-b35d-47c4-9317-57b40562d5fd` |
| Заголовок    | `Accept: application/json`                                                                             |
| Заголовок    | `Content-Type: application/json`                                                                       |
| Тело запроса | `{"identifier": "demo@domain.com", "password": "passwordvalue", "method": "password"}`                 |

CURL example:

```bash
curl -s -X POST \
-H "Accept: application/json" \
-H "Content-Type: application/json" \
-d '{"identifier": "demo@domain.com", "password": "passwordvalue", "method": "password"}' \
https://<auth.service>/self-service/login/methods/password?flow=35873140-b35d-47c4-9317-57b40562d5fd
```

response:

```json
{
  "session_token": "BTha0kwifDk79FYHcNPEbkXfOkxStwOR",
  "session": {
    "id": "b3e7db5d-1f4b-436c-b9bb-53b4d4f5887d",
    "active": true,
    "expires_at": "2021-07-28T21:28:20.595053963Z",
    "authenticated_at": "2021-06-21T21:28:20.595053963Z",
    ...
```

Из ответа вам необходимо значение поля `session_token`, например `BTha0kwifDk79FYHcNPEbkXfOkxStwOR`

Пример сценария получения списка доступных **Лэйаут**ов, предполагается наличие установленных утилит [curl](https://curl.se/download.html) и [jq](https://stedolan.github.io/jq/download/)

```bash
authService=https://auth.vkretail.ru
apiService=https://data.vkretail.ru
username=demo@data.vkretail.ru
password=q#HY%AGy5dqk

actionUrl=$(curl -s -X GET -H "Accept: application/json" $authService/self-service/login/api | jq -r '.methods.password.config.action')

token=$(curl -s -X POST -H  "Accept: application/json" -H "Content-Type: application/json" \
    -d '{"identifier": "demo@data.vkretail.ru", "password": "q#HY%AGy5dqk", "method": "password"}' \
    "$actionUrl" | jq -r '.session_token')

curl -s -H "Authorization: Bearer $token" \
  $apiService/v2/layouts | jq
```

```json
{
  "data": [
    {
      "id": "73685311",
      "title": "ТЦ Демо",
      "kind": "mall",
      "owner": {
        "id": "1000001",
        "title": "ТЦ Демо"
      },
      "is_active": true
    }
  ],
  "result_set": {
    "count": 1,
    "offset": 0,
    "limit": 20,
    "total": 15
  }
}
```

## Список основных методов

| #   | Путь                                   | Краткое описание                                                                                                   |
| --- | -------------------------------------- | ------------------------------------------------------------------------------------------------------------------ |
| 1   | `/v2/layouts`                          | Получить все доступные *лэйауты*                                                                                   |
| 2   | `/v2/layouts/{layout_id}`              | Получить определенный *лэйаут* по идентификатору                                                                   |
| 3   | `/v2/chains/stores`                    | Получить все магазины в определенной схеме размещения категории сеть                                               |
| 4   | `/v2/chains/stores/{store_id}`         | Получить определенный магазин по идентификатору в определенной схеме размещения категории сеть                     |
| 5   | `/v2/chains/entrances`                 | Получить все проходы в определенной схеме размещения категории сеть                                                |
| 6   | `/v2/chains/entrances/{entrance_id}`   | Получить определенный проход по идентификатору в определенной схеме размещения категории сеть                      |
| 7   | `/v2/malls/entrances`                  | Получить все проходы в определенной схеме размещения категории торговый центр                                      |
| 8   | `/v2/malls/entrances/{entrance_id}`    | Получить определенный проход по идентификатору в определенной схеме размещения категории торговый центр            |
| 9   | `/v2/malls/zones`                      | Получить все зоны в определенной схеме размещения категории торговый центр                                         |
| 10  | `/v2/malls/zones/{zone_id}`            | Получить определенную зону по идентификатору в определенной схеме размещения категории торговый центр              |
| 11  | `/v2/malls/renters`                    | Получить всех арендаторов в определенной схеме размещения категории торговый центр                                 |
| 12  | `/v2/malls/renters/{renter_id}`        | Получить определенного арендатора по идентификатору в определенной схеме размещения категории торговый центр       |
| 13  | `/v2/data/attendance/stores`           | Получить посещаемость магазинов в определенной схеме размещения категории сеть                                     |
| 14  | `/v2/data/attendance/stores/entrances` | Получить метрику посещаемость у проходов магазинов в определенной схеме размещения категории сеть                  |
| 15  | `/v2/data/attendance/malls/entrances`  | Получить метрику посещаемость у проходов торгового центра в определенной схеме размещения категории торговый центр |
| 16  | `/v2/data/attendance/malls/renters`    | Получить посещаемость арендаторов торгового центра в определенной схеме размещения категории торговый центр        |
| 17  | `/v2/data/attendance/malls/zones`      | Получить посещаемость зон торгового центра в определенной схеме размещения категории торговый центр                |
| 18  | `/v2/data/inside`                      | Получить количество посетителей внутри зоны                                                                        |
| 19  | `/v2/data/inside/days`                 | Получить количество посетителей внутри зоны по интервалам за определенный день                                     |
| 20  | `/v2/references/categories`            | Получить справочник товарных категорий                                                                             |
| 21  | `/v2/references/prices`                | Получить справочник ценовых сегментов                                                                              |

> openapi схема передается в виде отдельного файла `openapi.yaml`, для визуализации которого необходимо его открыть в [editor.swagger.io](https://editor.swagger.io/)
> 
> Так же предоставляется postman коллекция демонстрации основных методов.

![swagger](../../asset/img/Swagger%20Editor.png)